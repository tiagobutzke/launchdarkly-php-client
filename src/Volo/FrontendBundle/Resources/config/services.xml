<?xml version="1.0" ?>

<container xmlns="http://symfony.com/schema/dic/services"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd">

    <imports>
        <import resource="api.xml"/>
        <import resource="converters.xml"/>
        <import resource="redis_cache.xml"/>
        <import resource="wti.xml"/>
    </imports>

    <parameters>
        <parameter key="framework.service.session_handler.class">Drak\NativeSession\NativeRedisSessionHandler</parameter>
        <parameter key="twig.extension.intl.class">Twig_Extensions_Extension_Intl</parameter>
        <parameter key="volo_frontend.security.authenticator.class">Volo\FrontendBundle\Security\ApiAuthenticator</parameter>
        <parameter key="volo_frontend.twig.cms_extension.class">Volo\FrontendBundle\Twig\CmsExtension</parameter>
        <parameter key="volo_frontend.twig.vendor_extension.class">Volo\FrontendBundle\Twig\VendorExtension</parameter>
        <parameter key="volo_frontend.twig.gtmextension.class">Volo\FrontendBundle\Twig\GTMExtension</parameter>
        <parameter key="volo_frontend.service.configuration.class">Volo\FrontendBundle\Service\ConfigurationService</parameter>
        <parameter key="volo_frontend.service.customer.class">Volo\FrontendBundle\Service\CustomerService</parameter>
        <parameter key="volo_frontend.service.phone_number.class">Volo\FrontendBundle\Service\PhoneNumberService</parameter>
        <parameter key="volo_frontend.service.cart_manager.class">Volo\FrontendBundle\Service\CartManagerService</parameter>
        <parameter key="volo_frontend.service.order_manager.class">Volo\FrontendBundle\Service\OrderManagerService</parameter>
        <parameter key="volo_frontend.service.deliverability.class">Volo\FrontendBundle\Service\DeliverabilityService</parameter>
        <parameter key="volo_frontend.service.schedule.class">Volo\FrontendBundle\Service\ScheduleService</parameter>
        <parameter key="volo_frontend.cache_migration.class">Volo\FrontendBundle\CacheWarmer\MigrationCacheWarmer</parameter>
        <parameter key="volo_frontend.twig.serializer_extension.class">Volo\FrontendBundle\Twig\SerializerExtension</parameter>
        <parameter key="volo_frontend.service.customer_location.class">Volo\FrontendBundle\Service\CustomerLocationService</parameter>
        <parameter key="volo_frontend.service.vendor.class">Volo\FrontendBundle\Service\VendorService</parameter>
        <parameter key="volo_frontend.twig.vendor_image_extension.class">Volo\FrontendBundle\Twig\ThumborImageExtension</parameter>
        <parameter key="volo_frontend.twig.volo_extension.class">Volo\FrontendBundle\Twig\VoloExtension</parameter>
        <parameter key="volo_frontend.twig.cities_extension.class">Volo\FrontendBundle\Twig\CitiesExtension</parameter>
        <parameter key="volo_frontend.twig.order_extension.class">Volo\FrontendBundle\Twig\OrderExtension</parameter>
        <parameter key="volo_frontend.thumbor_builder_factory.class">Thumbor\Url\BuilderFactory</parameter>
        <parameter key="volo_frontend.thumbor_dumper.class">Volo\FrontendBundle\Dumper\ThumborConfigurationDumper</parameter>
        <parameter key="volo_frontend.service.api_error_translator.class">Volo\FrontendBundle\Service\ApiErrorTranslator</parameter>
        <parameter key="volo_frontend.twig.customer_location_extension.class">Volo\FrontendBundle\Twig\CustomerLocationExtension</parameter>
        <parameter key="volo_frontend.twig.customer_extension.class">Volo\FrontendBundle\Twig\CustomerExtension</parameter>
        <parameter key="volo_frontend.service.wti.class">Volo\FrontendBundle\Service\WTIService</parameter>
        <parameter key="volo_frontend.event_listener.coming_soon_listener.class">Volo\FrontendBundle\EventListener\ComingSoonListener</parameter>
        <parameter key="volo_frontend.security.ajax_authentication_success_handler.class">Volo\FrontendBundle\Security\AjaxAuthenticationSuccessListener</parameter>
        <parameter key="volo_frontend.security.ajax_authentication_failure_handler.class">Volo\FrontendBundle\Security\AjaxAuthenticationFailureListener</parameter>
        <parameter key="volo_frontend.event_listener.locale_listener.class">Volo\FrontendBundle\EventListener\LocaleListener</parameter>
        <parameter key="volo_frontend.provider.locale_config_provider.class">Volo\FrontendBundle\Provider\LocaleConfigProvider</parameter>
        <parameter key="volo_frontend.provider.address_config_provider.class">Volo\FrontendBundle\Provider\AddressConfigProvider</parameter>
        <parameter key="volo_frontend.service.event_service.class">Volo\FrontendBundle\Service\EventService</parameter>
        <parameter key="translator.class">Volo\FrontendBundle\Service\TranslatorService</parameter>
        <parameter key="volo_frontend.service.special_instructions_tutorial.class">Volo\FrontendBundle\Service\SpecialInstructionsTutorialService</parameter>
        <parameter key="volo_frontend.service.thumbor_service.class">Volo\FrontendBundle\Service\ThumborService</parameter>
        <parameter key="volo_frontend.service.city.class">Volo\FrontendBundle\Service\CityService</parameter>
        <parameter key="volo_frontend.site_map.client.class">GuzzleHttp\Client</parameter>
        <parameter key="volo_frontend.service.site_map.class">Volo\FrontendBundle\Service\SiteMapService</parameter>
    </parameters>

    <services>
        <service id="volo_frontend.provider.locale_config_provider" class="%volo_frontend.provider.locale_config_provider.class%">
            <argument>%localeSettings%</argument>
        </service>

        <service id="volo_frontend.provider.address_config_provider" class="%volo_frontend.provider.address_config_provider.class%">
            <argument>%address_config%</argument>
        </service>

        <service id="volo_frontend.service.special_instructions_tutorial" class="%volo_frontend.service.special_instructions_tutorial.class%">
            <argument id="volo_frontend.service.customer" type="service"/>
            <argument type="service" id="doctrine_cache.providers.special_instructions_cache" />
        </service>

        <service id="session.handler.redis" class="%framework.service.session_handler.class%">
            <argument type="string">%session_handler_redis_save_path%</argument>
        </service>

        <service id="volo_frontend.event_listener.locale_listener" class="%volo_frontend.event_listener.locale_listener.class%">
            <argument type="service" id="volo_frontend.service.configuration" />
            <argument type="service" id="volo_frontend.api.client" />
            <argument type="service" id="volo_frontend.provider.locale_config_provider" />
            <argument type="service" id="translator.default" />
            <argument type="service" id="router.default" />

            <tag name="kernel.event_listener" event="kernel.request" method="onKernelRequest" />
        </service>

        <service id="volo_frontend.event_listener.default_time_zone_listener"
                 class="Volo\FrontendBundle\EventListener\DefaultTimeZoneListener">
            <argument>%timezone%</argument>
            <tag name="kernel.event_listener" event="kernel.request" method="setDefaultTimeZone" priority="100" />
        </service>

        <service id="volo_frontend.twig.volo_extension" class="%volo_frontend.twig.volo_extension.class%">
            <argument type="service" id="translator" />
            <argument type="service" id="volo_frontend.service.cart_manager" />
            <argument type="service" id="volo_frontend.service.configuration" />
            <tag name="twig.extension"/>
        </service>

        <service id="volo_frontend.security.authenticator" class="%volo_frontend.security.authenticator.class%">
            <argument type="service" id="volo_frontend.service.customer" />
            <argument type="service" id="volo_frontend.api.authenticator" />
            <argument type="service" id="translator" />
        </service>

        <service id="volo_frontend.service.customer_manager" alias="volo_frontend.provider.customer" />
        <service id="volo_frontend.twig.cms_extension" class="%volo_frontend.twig.cms_extension.class%">
            <argument type="service" id="volo_frontend.provider.cms" />
            <tag name="twig.extension" />
        </service>

        <service id="volo_frontend.twig.cities_extension" class="%volo_frontend.twig.cities_extension.class%">
            <argument type="service" id="volo_frontend.provider.city" />
            <tag name="twig.extension" />
        </service>

        <service id="volo_frontend.twig.customer_location_extension" class="%volo_frontend.twig.customer_location_extension.class%">
            <argument id="volo_frontend.service.customer_location" type="service"/>
            <argument id="request_stack" type="service"/>
            <tag name="twig.extension"/>
        </service>

        <service id="volo_frontend.twig.customer_extension" class="%volo_frontend.twig.customer_extension.class%">
            <argument id="security.context" type="service"/>
            <argument id="security.authorization_checker" type="service"/>
            <tag name="twig.extension"/>
        </service>

        <service id="volo_frontend.twig.vendor_extension" class="%volo_frontend.twig.vendor_extension.class%">
            <argument type="service" id="volo_frontend.service.schedule" />
            <argument type="service" id="volo_frontend.service.event_service" />
            <tag name="twig.extension" />
        </service>

        <service id="volo_frontend.twig.order_extension" class="%volo_frontend.twig.order_extension.class%">
            <tag name="twig.extension" />
        </service>

        <service id="volo_frontend.twig.gtmextension" class="%volo_frontend.twig.gtmextension.class%">
            <argument>%country_code%</argument>
            <argument id="volo_frontend.service.schedule" type="service"/>
            <argument id="request_stack" type="service"/>
            <tag name="twig.extension"/>
        </service>

        <service id="volo_frontend.service.cart_manager" class="%volo_frontend.service.cart_manager.class%">
            <argument type="service" id="volo_frontend.provider.cart" />
            <argument type="service" id="volo_frontend.provider.vendor" />
            <argument type="service" id="security.token_storage" />
        </service>

        <service id="volo_frontend.service.order_manager" class="%volo_frontend.service.order_manager.class%">
            <argument type="service" id="volo_frontend.provider.order" />
            <argument type="service" id="volo_frontend.provider.customer" />
            <argument type="service" id="volo_frontend.service.cart_manager" />
            <argument type="service" id="volo_frontend.service.vendor" />
            <argument>%foodpanda.api.client_id%</argument>
        </service>

        <service id="volo_frontend.service.configuration" class="%volo_frontend.service.configuration.class%">
            <argument type="service" id="volo_frontend.provider.configuration" />
        </service>

        <service id="volo_frontend.service.wti" class="%volo_frontend.service.wti.class%">
            <argument type="service" id="foodpanda.web_translate_it.service.translation" />
            <argument type="service" id="file_locator" />
            <argument>@VoloFrontendBundle</argument>
        </service>

        <service id="volo_frontend.cache_migration" class="%volo_frontend.cache_migration.class%">
            <argument type="service" id="volo_frontend.service.vendor" />
            <tag name="kernel.cache_warmer" priority="90" />
        </service>

        <service id="volo_frontend.service.customer" class="%volo_frontend.service.customer.class%">
            <argument type="service" id="security.token_storage" />
            <argument type="service" id="volo_frontend.provider.customer" />
            <argument type="service" id="volo_frontend.api.serializer"/>
            <argument type="service" id="volo_frontend.service.phone_number" />
        </service>

        <service id="volo_frontend.service.vendor" class="%volo_frontend.service.vendor.class%">
            <argument type="service" id="volo_frontend.provider.city" />
            <argument type="service" id="volo_frontend.provider.vendor" />
            <argument type="service" id="volo_frontend.service.schedule" />
            <argument type="service" id="doctrine_cache.providers.vendor_cache" />
            <argument type="service" id="volo_frontend.service.thumbor_service" />
            <argument type="service" id="translator" />
            <argument type="service" id="volo_frontend.twig.volo_extension" />
        </service>

        <service id="volo_frontend.twig.serializer_extension" class="%volo_frontend.twig.serializer_extension.class%">
            <argument type="service" id="volo_frontend.api.serializer" />
            <tag name="twig.extension" />
        </service>

        <service id="volo_frontend.thumbor_builder_factory" class="%volo_frontend.thumbor_builder_factory.class%">
            <argument type="string">%volo_frontend.thumbor_base_url%</argument>
            <argument type="string">%volo_frontend.thumbor_secret%</argument>
        </service>

        <!-- the class property is needed even if the service is constructed by a factory
             since symfony might need to add method calls based on compile-time checks. -->
        <service id="volo_frontend.thumbor_transformers" class="ArrayObject" public="false">
            <factory service="service_container" method="getParameter"/>
            <argument>phumbor.transformations</argument>
        </service>

        <service id="volo_frontend.twig.vendor_image_extension" class="%volo_frontend.twig.vendor_image_extension.class%">
            <argument type="service" id="volo_frontend.thumbor_transformers" />
            <tag name="twig.extension" />
        </service>

        <service id="volo_frontend.thumbor_dumper" class="%volo_frontend.thumbor_dumper.class%">
            <argument type="service" id="volo_frontend.thumbor_transformers" />
        </service>

        <service id="volo_frontend.service.deliverability" class="%volo_frontend.service.deliverability.class%">
            <argument type="service" id="volo_frontend.provider.vendor" />
        </service>

        <service id="volo_frontend.service.customer_location" class="%volo_frontend.service.customer_location.class%">
            <argument>%address_config%</argument>
        </service>

        <service id="volo_frontend.service.phone_number" class="%volo_frontend.service.phone_number.class%">
            <argument type="service" id="libphonenumber.phone_number_util" />
            <argument>%country_code%</argument>
            <argument type="service" id="translator" />
        </service>

        <service id="volo_frontend.service.api_error_translator" class="%volo_frontend.service.api_error_translator.class%">
            <argument type="service" id="translator" />
            <argument type="service" id="logger" />
        </service>

        <service id="volo_frontend.service.schedule" class="%volo_frontend.service.schedule.class%">
            <argument type="service" id="doctrine_cache.providers.schedule_cache" />
            <argument type="service" id="translator" />
            <argument>%timepicker_date_format%</argument>
        </service>

        <service id="volo_frontend.event_listener.coming_soon_listener" class="%volo_frontend.event_listener.coming_soon_listener.class%">
            <argument id="templating" type="service"/>
            <argument type="service" id="router" />
            <argument>%is_coming_soon_enabled%</argument>
            <tag name="kernel.event_listener" event="kernel.request" method="onKernelRequest" priority="100" />
        </service>

        <service id="volo_frontend.security.ajax_authentication_success_handler"
                 class="%volo_frontend.security.ajax_authentication_success_handler.class%"
                 parent="security.authentication.success_handler">
            <argument type="service" id="volo_frontend.service.customer"/>
        </service>

        <service id="volo_frontend.service.event_service" class="%volo_frontend.service.event_service.class%">
            <argument type="service" id="volo_frontend.provider.vendor"/>
        </service>

        <service id="volo_frontend.service.thumbor_service" class="%volo_frontend.service.thumbor_service.class%">
            <argument id="phumbor.url.transformer" type="service"/>
            <argument id="assets.packages" type="service"/>
        </service>

        <service id="volo_frontend.service.city" class="%volo_frontend.service.city.class%">
            <argument type="service" id="volo_frontend.provider.city"/>
        </service>

        <service id="volo_frontend.site_map.client" class="%volo_frontend.site_map.client.class%" public="false">
            <argument type="collection">
                <argument key="base_url" type="string">%sitemap.s3.base_url%/</argument>
            </argument>
        </service>

        <service id="volo_frontend.service.site_map" class="%volo_frontend.service.site_map.class%">
            <argument id="volo_frontend.site_map.client" type="service"/>
        </service>
    </services>
</container>
